# CI/CD Pipeline for CAD Material Tracker
# Fully automated: Push to main â†’ Deployed to EC2
# Includes all fixes for: Tesseract, OpenCV, Nginx, WebSocket, Large files
# Required GitHub Secrets: EC2_HOST, EC2_SSH_KEY, ROBOFLOW_API_KEY, ROBOFLOW_MODEL_ID, OPENAI_API_KEY

name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  APP_NAME: cad-material-tracker
  APP_DIR: /home/ec2-user/cad-material-tracker

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup and Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          command_timeout: 60m
          script: |
            set -e
            
            echo "ğŸš€ Starting deployment..."
            
            # ========================================
            # SYSTEM CONFIGURATION (Large file support)
            # ========================================
            
            echo "âš™ï¸ Configuring system for large file uploads..."
            
            # Kernel network buffers for large uploads
            if ! grep -q "net.core.rmem_max" /etc/sysctl.conf; then
              sudo tee -a /etc/sysctl.conf > /dev/null << 'SYSCTL'
            net.core.rmem_max = 134217728
            net.core.wmem_max = 134217728
            net.ipv4.tcp_rmem = 4096 87380 134217728
            net.ipv4.tcp_wmem = 4096 65536 134217728
            net.ipv4.tcp_keepalive_time = 600
            net.ipv4.tcp_keepalive_intvl = 60
            net.ipv4.tcp_keepalive_probes = 10
            fs.file-max = 65535
            SYSCTL
              sudo sysctl -p || true
            fi
            
            # Add swap space (8GB) to prevent OOM on large PDFs
            if [ ! -f /swapfile ]; then
              echo "ğŸ’¾ Creating 8GB swap space..."
              sudo dd if=/dev/zero of=/swapfile bs=1M count=8192 status=progress
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
              echo "âœ… Swap enabled"
            else
              sudo swapon /swapfile 2>/dev/null || true
            fi
            
            # ========================================
            # INSTALL DEPENDENCIES
            # ========================================
            
            # Install Python 3.12
            if ! command -v python3.12 &> /dev/null; then
              echo "ğŸ“¦ Installing Python 3.12..."
              sudo dnf install -y python3.12 python3.12-pip python3.12-devel
            fi
            
            # Install Git
            if ! command -v git &> /dev/null; then
              echo "ğŸ“‚ Installing Git..."
              sudo dnf install -y git
            fi
            
            # Install OpenCV dependencies (libGL fix)
            echo "ğŸ“¦ Installing OpenCV dependencies..."
            sudo dnf install -y mesa-libGL mesa-libGL-devel libglvnd-glx || true
            
            # ========================================
            # TESSERACT OCR (Build from source for Amazon Linux 2023)
            # ========================================
            
            if ! command -v tesseract &> /dev/null; then
              echo "ğŸ“ Installing Tesseract OCR from source..."
              
              # Install build dependencies
              sudo dnf groupinstall -y "Development Tools" || true
              sudo dnf install -y autoconf automake libtool wget libjpeg-turbo-devel libpng-devel libtiff-devel zlib-devel giflib-devel freetype-devel || true
              
              # Install Leptonica (required by Tesseract)
              cd /tmp
              if [ ! -f /usr/local/lib/liblept.so ]; then
                echo "ğŸ“¦ Building Leptonica..."
                wget -q http://www.leptonica.org/source/leptonica-1.82.0.tar.gz || true
                tar -xzf leptonica-1.82.0.tar.gz || true
                cd leptonica-1.82.0
                ./configure --quiet
                make -j$(nproc)
                sudo make install
                sudo ldconfig
              fi
              
              # Install Tesseract
              cd /tmp
              if [ ! -f /usr/local/bin/tesseract ]; then
                echo "ğŸ“¦ Building Tesseract..."
                wget -q https://github.com/tesseract-ocr/tesseract/archive/refs/tags/5.3.0.tar.gz || true
                tar -xzf 5.3.0.tar.gz || true
                cd tesseract-5.3.0
                export PKG_CONFIG_PATH=/usr/local/lib/pkgconfig
                export LD_LIBRARY_PATH=/usr/local/lib
                ./autogen.sh
                ./configure --quiet
                make -j$(nproc)
                sudo make install
                sudo ldconfig
              fi
              
              # Download English language data
              sudo mkdir -p /usr/local/share/tessdata
              if [ ! -f /usr/local/share/tessdata/eng.traineddata ]; then
                echo "ğŸ“¦ Downloading Tesseract language data..."
                sudo wget -q -O /usr/local/share/tessdata/eng.traineddata https://github.com/tesseract-ocr/tessdata/raw/main/eng.traineddata
              fi
              
              cd /home/ec2-user
            fi
            
            # Verify Tesseract
            tesseract --version || echo "âš ï¸ Tesseract verification failed"
            
            # ========================================
            # NGINX SETUP (Large files + WebSocket)
            # ========================================
            
            if ! command -v nginx &> /dev/null; then
              echo "ğŸŒ Installing Nginx..."
              sudo dnf install -y nginx
            fi
            
            echo "ğŸŒ Configuring Nginx for large files and WebSocket..."
            
            # Create temp directory for uploads
            sudo mkdir -p /tmp/nginx_uploads
            sudo chown nginx:nginx /tmp/nginx_uploads 2>/dev/null || sudo chown ec2-user:ec2-user /tmp/nginx_uploads
            sudo chmod 755 /tmp/nginx_uploads
            
            # Nginx config with all fixes
            sudo tee /etc/nginx/conf.d/cad-tracker.conf > /dev/null << 'NGINXCONF'
            upstream cad_backend {
                server 127.0.0.1:8000;
                keepalive 1000;
            }

            server {
                listen 80;
                server_name _;
                
                # Large file uploads (2GB max)
                client_max_body_size 2G;
                client_body_timeout 7200s;
                client_body_buffer_size 10M;
                client_body_temp_path /tmp/nginx_uploads;
                
                # Disable request buffering - stream directly to backend
                proxy_request_buffering off;
                proxy_buffering off;
                
                # Long timeouts for large files
                proxy_connect_timeout 7200s;
                proxy_send_timeout 7200s;
                proxy_read_timeout 7200s;
                send_timeout 7200s;
                keepalive_timeout 0;
                
                # Disable reset on close
                reset_timedout_connection off;
                
                # Gzip compression
                gzip on;
                gzip_types text/plain text/css application/json application/javascript;
                
                location / {
                    proxy_pass http://cad_backend;
                    proxy_http_version 1.1;
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    proxy_set_header X-Forwarded-Proto $scheme;
                    proxy_set_header Connection "";
                }
                
                # WebSocket endpoint - CRITICAL: No buffering, no timeout
                location /ws {
                    proxy_pass http://cad_backend/ws;
                    
                    # WebSocket upgrade headers
                    proxy_http_version 1.1;
                    proxy_set_header Upgrade $http_upgrade;
                    proxy_set_header Connection "upgrade";
                    
                    # Pass through headers
                    proxy_set_header Host $host;
                    proxy_set_header X-Real-IP $remote_addr;
                    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                    
                    # CRITICAL: Infinite timeout (7 days in seconds)
                    proxy_read_timeout 604800s;
                    proxy_send_timeout 604800s;
                    proxy_connect_timeout 60s;
                    
                    # CRITICAL: No buffering at all
                    proxy_buffering off;
                    proxy_cache off;
                    proxy_request_buffering off;
                    proxy_set_header X-Accel-Buffering no;
                    
                    # TCP keep-alive
                    tcp_nodelay on;
                }
                
                # Health check
                location /health {
                    access_log off;
                    return 200 "OK";
                    add_header Content-Type text/plain;
                }
            }
            NGINXCONF
            
            # Remove default config if exists
            sudo rm -f /etc/nginx/conf.d/default.conf 2>/dev/null || true
            
            # Test and restart Nginx
            sudo nginx -t && echo "Nginx config OK" || (echo "Nginx config FAILED" && exit 1)
            sudo systemctl enable nginx
            sudo systemctl restart nginx
            sudo systemctl status nginx --no-pager || true
            
            # ========================================
            # APP SETUP & DEPLOYMENT
            # ========================================
            
            mkdir -p /home/ec2-user/cad-material-tracker
            cd /home/ec2-user/cad-material-tracker
            
            # Clone or pull repo
            if [ ! -d ".git" ]; then
              echo "ğŸ“¥ Cloning repository..."
              git clone https://github.com/abbasghori29/CAD-material-tracker.git .
            else
              echo "ğŸ“¥ Pulling latest code..."
              git fetch origin
              git reset --hard origin/main
            fi
            
            # Create virtual environment
            if [ ! -d "venv312" ]; then
              echo "ğŸ”§ Creating Python virtual environment..."
              python3.12 -m venv venv312
            fi
            
            # Install dependencies
            echo "ğŸ“¦ Installing Python dependencies..."
            source venv312/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt
            
            # ========================================
            # FIX: Tesseract path in app.py
            # ========================================
            
            # Tesseract path is now auto-detected in app.py
            # No manual patching needed - code checks common paths + system PATH
            
            # ========================================
            # ENVIRONMENT FILE
            # ========================================
            
            echo "âš™ï¸ Creating/Updating .env file..."
            cat > .env << ENVFILE
            ROBOFLOW_API_KEY=${{ secrets.ROBOFLOW_API_KEY }}
            ROBOFLOW_MODEL_ID=${{ secrets.ROBOFLOW_MODEL_ID }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            AUTO_CLEANUP=true
            ENVFILE
            
            # ========================================
            # SYSTEMD SERVICE (with all environment vars)
            # ========================================
            
            echo "ğŸ”„ Configuring systemd service..."
            sudo tee /etc/systemd/system/cad-tracker.service > /dev/null << 'SERVICE'
            [Unit]
            Description=CAD Material Tracker FastAPI Application
            After=network.target nginx.service
            Wants=nginx.service

            [Service]
            Type=simple
            User=ec2-user
            Group=ec2-user
            WorkingDirectory=/home/ec2-user/cad-material-tracker
            Environment="PATH=/home/ec2-user/cad-material-tracker/venv312/bin:/usr/local/bin:/usr/bin"
            Environment="TESSDATA_PREFIX=/usr/local/share/tessdata"
            Environment="LD_LIBRARY_PATH=/usr/local/lib"
            Environment="PYTHONUNBUFFERED=1"
            ExecStart=/home/ec2-user/cad-material-tracker/venv312/bin/python -u /home/ec2-user/cad-material-tracker/server.py
            Restart=always
            RestartSec=5
            StandardOutput=journal
            StandardError=journal

            [Install]
            WantedBy=multi-user.target
            SERVICE
            
            # Reload and restart
            sudo systemctl daemon-reload
            sudo systemctl enable cad-tracker
            sudo systemctl restart cad-tracker
            
            # Wait for app to start
            sleep 5
            
            # ========================================
            # VERIFICATION
            # ========================================
            
            echo ""
            echo "============================================"
            echo "âœ… DEPLOYMENT COMPLETE!"
            echo "============================================"
            echo ""
            echo "ğŸŒ App URL: http://${{ secrets.EC2_HOST }}"
            echo "ğŸ”Œ WebSocket: ws://${{ secrets.EC2_HOST }}/ws"
            echo ""
            echo "ğŸ“‹ Installed Components:"
            echo "   - Python 3.12: $(python3.12 --version 2>&1 || echo 'Not found')"
            echo "   - Tesseract: $(tesseract --version 2>&1 | head -1 || echo 'Not found')"
            echo "   - Nginx: $(nginx -v 2>&1 || echo 'Not found')"
            echo ""
            echo "ğŸ”‘ API Keys Configured:"
            echo "   - Roboflow: $([ -n '${{ secrets.ROBOFLOW_API_KEY }}' ] && echo 'âœ… Set' || echo 'âŒ Missing')"
            echo "   - OpenAI: $([ -n '${{ secrets.OPENAI_API_KEY }}' ] && echo 'âœ… Set' || echo 'âŒ Missing')"
            echo ""
            echo "ğŸ“Š Service Status:"
            sudo systemctl status cad-tracker --no-pager -l || true
            echo ""
            echo "============================================"
